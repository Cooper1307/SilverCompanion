<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“¶é¾„å°åŠ©æ‰‹ - MVP Demo</title>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root {
            --primary: #2196f3;
            --bg: #f5f7fa;
            --glass: rgba(255, 255, 255, 0.85);
        }

        body {
            font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        .container {
            max-width: 700px;
            width: 100%;
            background: var(--glass);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            padding: 40px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        h1 {
            color: #1a237e;
            font-size: 48px;
            margin-bottom: 30px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        #chat-window {
            height: 400px;
            overflow-y: auto;
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.5);
            scroll-behavior: smooth;
        }

        .message {
            margin: 20px 0;
            padding: 20px 25px;
            border-radius: 25px;
            line-height: 1.6;
            font-size: 26px;
            /* é€‚è€åŒ–å¤§å­—å· */
            max-width: 85%;
            animation: fadeIn 0.3s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .ai {
            background: white;
            color: #1a237e;
            align-self: flex-start;
            box-shadow: 0 5px 15px rgba(33, 150, 243, 0.1);
            border-bottom-left-radius: 5px;
        }

        .user {
            background: #2196f3;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .input-area {
            position: relative;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input {
            width: 100%;
            padding: 25px;
            font-size: 26px;
            border: 3px solid #dee2e6;
            border-radius: 20px;
            box-sizing: border-box;
            transition: border-color 0.3s;
        }

        input:focus {
            border-color: var(--primary);
            outline: none;
        }

        .suggestion-box {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin-bottom: 20px;
        }

        .tag {
            background: #fff;
            color: #1e88e5;
            padding: 10px 20px;
            border-radius: 30px;
            font-size: 20px;
            cursor: pointer;
            border: 2px solid #e3f2fd;
            transition: all 0.2s;
        }

        .tag:hover {
            background: #e3f2fd;
            transform: scale(1.05);
        }

        .btn-group {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .send-btn {
            background: #1a237e;
            color: white;
            padding: 20px 50px;
            font-size: 28px;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 10px 20px rgba(26, 35, 126, 0.3);
        }

        .mic-btn {
            background: #ff5252;
            width: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: pulse 2s infinite;
            transition: all 0.3s ease;
            border: none;
            font-size: 28px;
        }

        .mic-btn.recording {
            background: #d32f2f;
            animation: none;
            box-shadow: 0 0 0 8px rgba(211, 47, 47, 0.3);
        }

        .mic-btn:disabled {
            background: #bdbdbd;
            cursor: not-allowed;
            animation: none;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(255, 82, 82, 0.4);
            }

            70% {
                box-shadow: 0 0 0 15px rgba(255, 82, 82, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(255, 82, 82, 0);
            }
        }

        .loading {
            color: #5c6bc0;
            font-size: 20px;
            margin-top: 10px;
            font-weight: 500;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ğŸ‘´ é“¶é¾„å°åŠ©æ‰‹ (æ——èˆ°ç‰ˆ)</h1>

        <div id="chat-window">
            <div class="message ai">è€äººå®¶æ‚¨å¥½ï¼æˆ‘æ˜¯æ‚¨çš„ç”Ÿæ´»ç®¡å®¶å°å¼ ã€‚æœ‰ä»€ä¹ˆæˆ‘èƒ½å¸®æ‚¨çš„å—ï¼Ÿ</div>
            <div class="message ai">æ‚¨å¯ä»¥ç›´æ¥æ‰“å­—ï¼Œæˆ–è€…ç‚¹ä¸‹é¢çš„æŒ‰é’®é—®æˆ‘å“¦ï¼š</div>
        </div>

        <div class="suggestion-box" id="suggestions">
            <div class="tag" onclick="useTag('é•¿æŠ¤é™©æ€ä¹ˆç”³è¯·ï¼Ÿ')">ğŸ“„ ç”³è¯·é•¿æŠ¤é™©</div>
            <div class="tag" onclick="useTag('é™„è¿‘æœ‰å…»è€åŠ©é¤ç‚¹å—ï¼Ÿ')">ğŸ± æ‰¾åŠ©é¤ç‚¹</div>
            <div class="tag" onclick="useTag('å¦‚ä½•é¢„é˜²é«˜è¡€å‹ï¼Ÿ')">ğŸ å¥åº·å»ºè®®</div>
        </div>

        <div class="input-area">
            <input type="text" id="user-input" placeholder="è¯·ç‚¹è¿™é‡Œè¯´è¯..." onkeypress="handleKeyPress(event)">
            <div class="btn-group">
                <button class="send-btn" onclick="sendMessage()">ç‚¹æˆ‘å‘é€</button>
                <button class="mic-btn" id="mic-btn" onclick="toggleVoiceInput()">ğŸ¤</button>
            </div>
            <div id="status" class="loading" style="display:none;">å°å¼ æ­£åœ¨ä¸ºæ‚¨æŸ¥è¯¢æ”¿ç­–ï¼Œè¯·ç¨å€™...</div>
        </div>
    </div>

    <script>
        const chatWindow = document.getElementById('chat-window');
        const userInput = document.getElementById('user-input');
        const statusDiv = document.getElementById('status');
        const suggestionsBox = document.getElementById('suggestions');

        // v2.1: ç”Ÿæˆå”¯ä¸€çš„ Session IDï¼Œé¿å…ç”¨æˆ·å†å²æ··æ·†
        function getSessionId() {
            let sessionId = localStorage.getItem('silver_session_id');
            if (!sessionId) {
                sessionId = 'user_' + Date.now() + '_' + Math.random().toString(36).substring(2, 9);
                localStorage.setItem('silver_session_id', sessionId);
            }
            return sessionId;
        }
        const SESSION_ID = getSessionId();

        function useTag(text) {
            userInput.value = text;
            sendMessage();
        }

        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            addMessage(message, 'user');
            userInput.value = '';
            statusDiv.style.display = 'block';

            try {
                const response = await axios.post('http://localhost:8001/chat', {
                    message: message,
                    user_id: SESSION_ID  // v2.1: ä½¿ç”¨å”¯ä¸€ Session ID
                });

                statusDiv.style.display = 'none';
                // v2.0 ä¼˜åŒ–: æ‰“å­—æœºæ•ˆæœ
                await typeMessage(response.data.response, 'ai');

                // v2.0 ä¼˜åŒ–: åŠ¨æ€æ›´æ–°å»ºè®®æ ‡ç­¾
                if (response.data.suggestions && response.data.suggestions.length > 0) {
                    updateSuggestions(response.data.suggestions);
                }
            } catch (error) {
                statusDiv.style.display = 'none';
                addMessage("è€äººå®¶å¯¹ä¸èµ·ï¼Œå®éªŒå®¤çš„â€˜å¤§è„‘â€™åå°è¿˜æ²¡æ¥é€šï¼ˆAPI Keyæœªé…ç½®ï¼‰ï¼Œæ‰€ä»¥æˆ‘ç°åœ¨åªèƒ½ç»™æ‚¨æ¼”ç¤ºæ ·å­ã€‚ç­‰æ­£å¼ç‰ˆæœ¬ä¸Šçº¿ï¼Œæˆ‘è‚¯å®šèƒ½å¯¹ç­”å¦‚æµï¼", 'ai');
            }
        }

        function addMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            div.innerText = text;
            chatWindow.appendChild(div);
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') sendMessage();
        }

        // v2.0: æ‰“å­—æœºæ•ˆæœå‡½æ•°
        async function typeMessage(text, type) {
            const div = document.createElement('div');
            div.className = `message ${type}`;
            chatWindow.appendChild(div);

            for (let i = 0; i < text.length; i++) {
                div.innerText = text.substring(0, i + 1);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                await new Promise(resolve => setTimeout(resolve, 25));
            }
        }

        // v2.0: åŠ¨æ€æ›´æ–°å»ºè®®æ ‡ç­¾
        function updateSuggestions(suggestions) {
            suggestionsBox.innerHTML = '';
            suggestions.forEach(sug => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerText = sug;
                tag.onclick = () => useTag(sug);
                suggestionsBox.appendChild(tag);
            });
        }

        // ========== v3.0: Web Speech API è¯­éŸ³è¾“å…¥ ==========
        const micBtn = document.getElementById('mic-btn');
        let recognition = null;
        let isRecording = false;

        // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
        if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'zh-CN';  // ä¸­æ–‡æ™®é€šè¯

            recognition.onstart = function () {
                isRecording = true;
                micBtn.classList.add('recording');
                micBtn.innerText = 'ğŸ”´';
                userInput.placeholder = 'æ­£åœ¨è†å¬æ‚¨è¯´è¯...';
            };

            recognition.onresult = function (event) {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                userInput.value = transcript;
            };

            recognition.onend = function () {
                isRecording = false;
                micBtn.classList.remove('recording');
                micBtn.innerText = 'ğŸ¤';
                userInput.placeholder = 'è¯·ç‚¹è¿™é‡Œè¯´è¯...';

                // è‡ªåŠ¨å‘é€ (å¦‚æœæœ‰å†…å®¹)
                if (userInput.value.trim()) {
                    sendMessage();
                }
            };

            recognition.onerror = function (event) {
                console.error('è¯­éŸ³è¯†åˆ«é”™è¯¯:', event.error);
                isRecording = false;
                micBtn.classList.remove('recording');
                micBtn.innerText = 'ğŸ¤';
                userInput.placeholder = 'è¯·ç‚¹è¿™é‡Œè¯´è¯...';

                if (event.error === 'no-speech') {
                    addMessage('è€äººå®¶ï¼Œæˆ‘æ²¡å¬æ¸…æ‚¨è¯´ä»€ä¹ˆï¼Œè¯·å†è¯´ä¸€éå¥½å—ï¼Ÿ', 'ai');
                } else if (event.error === 'not-allowed') {
                    addMessage('è€äººå®¶ï¼Œè¯·å…è®¸æµè§ˆå™¨ä½¿ç”¨éº¦å…‹é£ï¼Œæ‰èƒ½è¯­éŸ³èŠå¤©å“¦ã€‚', 'ai');
                }
            };
        }

        function toggleVoiceInput() {
            if (!recognition) {
                addMessage('è€äººå®¶ï¼Œæ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¾“å…¥ï¼Œè¯·ä½¿ç”¨Chromeæµè§ˆå™¨è¯•è¯•ã€‚', 'ai');
                return;
            }

            if (isRecording) {
                recognition.stop();
            } else {
                recognition.start();
            }
        }
    </script>

</body>

</html>